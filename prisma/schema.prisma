generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//  ==================================================
//  =               1. CORE MULTI-TENANCY            =
//  ==================================================

model Store {
  id Int @id @default(autoincrement())

  // FKs
  ownerId Int

  // Fields
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  owner              Employee            @relation("StoreOwner", fields: [ownerId], references: [id])
  categories         Category[]
  suppliers          Supplier[]
  products           Product[]
  customers          CustomerStore[]
  employees          Employee[]
  sales              Sale[]
  parkedSales        ParkedSale[]
  quickSaleItems     QuickSaleItem[]
  saleItems          SaleItem[]
  stockMovements     StockMovement[]
  stockAlerts        StockAlert[]
  purchaseOrders     PurchaseOrder[]
  purchaseOrderItems PurchaseOrderItem[]
  cashDrawers        CashDrawer[]
  posSettings        POSSettings[]
  notifications      Notification[]
  auditLogs          AuditLog[]
}

// ==================================================
// =                   2. EMPLOYEES                 =
// ==================================================

model Employee {
  id Int @id @default(autoincrement())

  // FKs
  storeId Int?

  // Fields
  name            String
  username        String    @unique
  email           String?   @unique
  phone           String?
  photo           String?
  joinedDate      DateTime?
  salary          Float?
  contractDetails String?
  notes           String?
  pinCode         String
  role            String    @default("CASHIER")
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  store        Store?        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  auditLogs    AuditLog[]
  CashDrawer   CashDrawer[]
  posSettings  POSSettings[]
  parkedSales  ParkedSale[]
  sales        Sale[]
  salarySheets SalarySheet[]
  storesOwned  Store[]       @relation("StoreOwner")
}

model SalarySheet {
  id Int @id @default(autoincrement())

  // FKs
  employeeId Int

  // Fields
  month      Int
  year       Int
  baseSalary Float
  bonus      Float?
  deduction  Float?
  paid       Boolean   @default(false)
  paidAt     DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])
}

model AuditLog {
  id Int @id @default(autoincrement())

  // FKs
  storeId    Int
  employeeId Int?

  // Fields
  action    String
  entity    String?
  entityId  Int?
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  employee Employee? @relation(fields: [employeeId], references: [id])
}

// ==================================================
// =                   3. PRODUCTS                  =
// ==================================================

model Category {
  id Int @id @default(autoincrement())

  // FKs
  storeId Int

  // Fields
  name      String   @unique
  icon      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  products Product[]
}

model Supplier {
  id Int @id @default(autoincrement())

  // FKs
  storeId Int

  // Fields
  name        String
  contactName String?
  phone       String?
  email       String?  @unique
  address     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  store         Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  products      Product[]
  PurchaseOrder PurchaseOrder[]
}

model Product {
  id Int @id @default(autoincrement())

  // FKs
  storeId    Int
  categoryId Int
  supplierId Int?

  // Fields
  name              String
  sku               String    @unique
  barcode           String?   @unique
  description       String?
  purchasePrice     Float
  sellingPrice      Float
  stockQuantity     Float     @default(0)
  lowStockThreshold Int       @default(10)
  isWeighted        Boolean   @default(false)
  isActive          Boolean   @default(true)
  isDeleted         Boolean   @default(false)
  taxRate           Float     @default(0)
  image             String?
  unit              String?   @default("pcs")
  hasVariants       Boolean   @default(false)
  expiryDate        DateTime?
  lastSoldDate      DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  store             Store               @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category          Category            @relation(fields: [categoryId], references: [id])
  supplier          Supplier?           @relation(fields: [supplierId], references: [id])
  variants          ProductVariant[]
  PurchaseOrderItem PurchaseOrderItem[]
  quickSaleItems    QuickSaleItem[]
  saleItems         SaleItem[]
  stockAlerts       StockAlert[]
  stockMovements    StockMovement[]
  notifications     Notification[]
}

model ProductVariant {
  id Int @id @default(autoincrement())

  // FKs
  productId Int

  // Fields
  name          String
  sku           String   @unique
  barcode       String?  @unique
  purchasePrice Float
  sellingPrice  Float
  stockQuantity Float    @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  saleItems      SaleItem[]
  stockMovements StockMovement[]
}

// ==================================================
// =                     4. SALES                   =
// ==================================================

model Sale {
  id Int @id @default(autoincrement())

  // FKs
  storeId    Int
  employeeId Int
  customerId Int?
  offerId    Int?

  // Fields
  receiptId       String   @unique
  subtotal        Float
  taxAmount       Float    @default(0)
  discountAmount  Float    @default(0)
  loyaltyDiscount Float    @default(0)
  offerTitle      String?
  offerDiscount   Float?   @default(0)
  finalAmount     Float
  paymentMethod   String
  paymentStatus   String   @default("COMPLETED")
  cashReceived    Float?
  changeGiven     Float?
  notes           String?
  discountReason  String?
  pointsEarned    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  //  Relations
  store              Store               @relation(fields: [storeId], references: [id], onDelete: Cascade)
  employee           Employee            @relation(fields: [employeeId], references: [id])
  customer           Customer?           @relation(fields: [customerId], references: [id])
  saleItems          SaleItem[]
  paymentSplits      PaymentSplit[]
  pointsTransactions PointsTransaction[]
}

model SaleItem {
  id Int @id @default(autoincrement())

  // FKs
  saleId           Int
  productId        Int
  productVariantId Int?
  storeId          Int

  // Fields
  quantity    Float
  priceAtSale Float
  discount    Float @default(0)
  subtotal    Float

  // Relations
  sale           Sale            @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product        Product         @relation(fields: [productId], references: [id])
  productVariant ProductVariant? @relation(fields: [productVariantId], references: [id])
  store          Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

model PaymentSplit {
  id Int @id @default(autoincrement())

  // FKs
  saleId Int

  // Fields
  paymentMethod String
  amount        Float
  createdAt     DateTime @default(now())

  // Relations
  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)
}

// ==================================================
// =                 5. LOYALTY SYSTEM              =
// ==================================================

model Customer {
  id Int @id @default(autoincrement())

  name        String
  phoneNumber String?   @unique
  email       String?   @unique
  dateOfBirth DateTime?
  address     String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  customerStores     CustomerStore[]
  loyaltyRewards     LoyaltyReward[]
  parkedSales        ParkedSale[]
  pointsTransactions PointsTransaction[]
  sales              Sale[]
}

model CustomerStore {
  id Int @id @default(autoincrement())

  // FKs
  customerId    Int
  storeId       Int
  loyaltyPoints Int    @default(0)
  loyaltyTier   String @default("BRONZE")

  // Relations
  customer           Customer            @relation(fields: [customerId], references: [id])
  store              Store               @relation(fields: [storeId], references: [id])
  pointsTransactions PointsTransaction[]
  loyaltyRewards     LoyaltyReward[]

  @@unique([customerId, storeId])
}

model PointsTransaction {
  id Int @id @default(autoincrement())

  // FKs
  customerStoreId Int
  saleId          Int?

  // Fields
  type        String
  points      Int
  description String?
  createdAt   DateTime @default(now())

  // Relations
  customerStore CustomerStore @relation(fields: [customerStoreId], references: [id], onDelete: Cascade)
  sale          Sale?         @relation(fields: [saleId], references: [id])
  customer      Customer?     @relation(fields: [customerId], references: [id])
  customerId    Int?
}

model LoyaltyReward {
  id Int @id @default(autoincrement())

  // FKs
  customerStoreId Int

  // Fields
  rewardType  String
  rewardValue Float
  pointsCost  Int
  description String
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  redeemedAt  DateTime?
  createdAt   DateTime  @default(now())

  // Relations
  customerStore CustomerStore @relation(fields: [customerStoreId], references: [id], onDelete: Cascade)
  customer      Customer?     @relation(fields: [customerId], references: [id])
  customerId    Int?
}

model LoyaltyTierConfig {
  id                 Int     @id @default(autoincrement())
  tier               String  @unique
  minimumPoints      Int     @default(0)
  pointsMultiplier   Float   @default(1)
  discountPercentage Float   @default(0)
  birthdayBonus      Int     @default(0)
  description        String?
}

model LoyaltyOffer {
  id Int @id @default(autoincrement())

  // Fields
  title           String
  description     String
  offerType       String
  discountValue   Float?
  minimumPurchase Float    @default(0)
  requiredTier    String   @default("BRONZE")
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ==================================================
// =                 6. PURCHASE ORDERS             =
// ==================================================

model PurchaseOrder {
  id Int @id @default(autoincrement())

  // FKs
  supplierId Int
  storeId    Int

  // Fields
  poNumber     String    @unique
  status       String    @default("PENDING")
  orderDate    DateTime  @default(now())
  expectedDate DateTime?
  receivedDate DateTime?
  totalAmount  Float     @default(0)
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  supplier Supplier            @relation(fields: [supplierId], references: [id])
  store    Store               @relation(fields: [storeId], references: [id], onDelete: Cascade)
  items    PurchaseOrderItem[]
}

model PurchaseOrderItem {
  id Int @id @default(autoincrement())

  // FKs
  purchaseOrderId Int
  productId       Int
  storeId         Int

  // Fields
  quantity         Float
  unitCost         Float
  totalCost        Float
  receivedQuantity Float @default(0)

  // Relations
  product       Product       @relation(fields: [productId], references: [id])
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  store         Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

// ==================================================
// =                 7. INVENTORY / STOCK           =
// ==================================================

model StockMovement {
  id Int @id @default(autoincrement())

  // FKs
  productId        Int
  productVariantId Int?
  storeId          Int
  createdBy        Int?

  // Fields
  movementType String
  quantity     Float
  reason       String?
  reference    String?
  fromLocation String?
  toLocation   String?
  createdAt    DateTime @default(now())

  // Relations
  product        Product         @relation(fields: [productId], references: [id])
  productVariant ProductVariant? @relation(fields: [productVariantId], references: [id])
  store          Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

model StockAlert {
  id Int @id @default(autoincrement())

  // FKs
  productId Int
  storeId   Int

  // Fields
  alertType  String
  message    String
  isResolved Boolean   @default(false)
  resolvedAt DateTime?
  resolvedBy Int?
  createdAt  DateTime  @default(now())

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  store   Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

// ==================================================
// =                 8. POS SETTINGS                =
// ==================================================

model POSSettings {
  id Int @id @default(autoincrement())

  // FKs
  storeId   Int
  updatedBy Int?

  // Core
  systemErrorAlertEnabled Boolean @default(false)
  priceChangeAlertEnabled Boolean @default(false)
  enableQuickSale         Boolean @default(false)
  enableSplitPayment      Boolean @default(true)
  enableParkSale          Boolean @default(true)
  enableCustomerSearch    Boolean @default(true)
  enableBarcodeScanner    Boolean @default(true)
  enableLoyaltyPoints     Boolean @default(true)
  loyaltyPointsPerUnit    Float   @default(10)
  pointsRedemptionRate    Float   @default(100)

  // Store info
  storeName    String  @default("POS System")
  storeAddress String  @default("Chatmohar, Pabna, Dhaka, Bangladesh")
  storePhone   String  @default("+8801712345678")
  storeEmail   String? @unique
  taxId        String?
  taxRate      Float   @default(0)

  // Currency
  currencyCode     String @default("USD")
  currencySymbol   String @default("$")
  currencyPosition String @default("before")

  // Receipt
  receiptFooterText String?
  returnPolicy      String?
  printReceiptAuto  Boolean @default(false)
  autoPrintThermal  Boolean @default(true)

  // Alerts
  enableLowStockAlerts         Boolean @default(true)
  lowStockThreshold            Int     @default(10)
  enableHighStockAlerts        Boolean @default(false)
  highStockThreshold           Int     @default(1000)
  enableProductExpiryAlerts    Boolean @default(false)
  productExpiryDays            Int     @default(7)
  supplierDeliveryAlertEnabled Boolean @default(false)
  expectedDeliveryDays         Int     @default(7)
  inactiveProductAlertEnabled  Boolean @default(false)
  inactiveProductDays          Int     @default(30)
  lowBalanceAlertEnabled       Boolean @default(false)
  lowBalanceThreshold          Float   @default(100)
  frequentRefundsAlertEnabled  Boolean @default(false)
  frequentRefundsThreshold     Int     @default(3)

  // Security
  autoLogoutMinutes     Int     @default(30)
  requirePasswordOnVoid Boolean @default(true)
  enableAuditLog        Boolean @default(true)

  // Product listing
  productsPerPage   Int     @default(20)
  defaultView       String  @default("grid")
  showProductImages Boolean @default(true)

  // Sales targets
  dailySalesTargetAlertEnabled Boolean @default(false)
  dailySalesTargetAmount       Int     @default(1000)

  // Loyalty expiry
  loyaltyPointsExpiryAlertEnabled Boolean @default(false)
  loyaltyPointsExpiryDays         Int     @default(30)

  updatedAt DateTime @updatedAt

  // Relations
  store             Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  updatedByEmployee Employee? @relation(fields: [updatedBy], references: [id])
}

// ==================================================
// =                     9. MISC                    =
// ==================================================

model CashDrawer {
  id Int @id @default(autoincrement())

  // FKs
  employeeId Int
  storeId    Int

  // Fields
  openingBalance  Float
  closingBalance  Float?
  expectedBalance Float?
  difference      Float?
  status          String    @default("OPEN")
  openedAt        DateTime  @default(now())
  closedAt        DateTime?

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])
  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

model ParkedSale {
  id Int @id @default(autoincrement())

  // FKs
  employeeId Int
  customerId Int?
  storeId    Int

  // Fields
  items          String
  subtotal       Float
  taxAmount      Float     @default(0)
  discountAmount Float     @default(0)
  notes          String?
  parkedAt       DateTime  @default(now())
  expiresAt      DateTime?

  // Relations
  employee Employee  @relation(fields: [employeeId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])
  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

model QuickSaleItem {
  id Int @id @default(autoincrement())

  // FKs
  productId Int
  storeId   Int

  // Fields
  displayName String
  color       String  @default("#3B82F6")
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  store   Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

model Notification {
  id Int @id @default(autoincrement())

  // FKs
  storeId   Int
  productId Int?

  // Fields
  type      String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  store   Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])
}
